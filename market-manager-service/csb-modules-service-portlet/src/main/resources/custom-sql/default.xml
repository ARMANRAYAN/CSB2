<?xml version="1.0" encoding="UTF-8"?>
<custom-sql>
    <sql id="com.arman.csb.modules.service.MyBlogService.getGroupBlogs">
        <![CDATA[
        SELECT  distinct BlogsEntry.* , commentCNT.cnt as commentCount FROM BlogsEntry

        LEFT OUTER JOIN
        (
            SELECT AssetEntry.classPK, AssetCategory.name FROM AssetEntry

            INNER JOIN AssetEntries_AssetCategories  ON AssetEntries_AssetCategories.entryId = AssetEntry.entryId

            INNER JOIN AssetCategory ON AssetCategory.categoryId = AssetEntries_AssetCategories.categoryId
        ) AS cat ON BlogsEntry.entryId =cat.classPK

        LEFT OUTER JOIN
        (
            SELECT AssetEntry.classPK, AssetTag.name FROM AssetEntry

            INNER JOIN AssetEntries_AssetTags ON AssetEntries_AssetTags.entryId = AssetEntry.entryId

            INNER JOIN AssetTag ON AssetTag.tagId = AssetEntries_AssetTags.tagId
        ) AS tgs ON tgs.classPK = BlogsEntry.entryId

        LEFT OUTER JOIN
        (
            SELECT MBMessage.classPK , count(*) AS cnt FROM MBMessage GROUP BY classPK
        ) AS commentCNT ON commentCNT.classPK = BlogsEntry.entryId

        WHERE

            (cat.name IN (?) OR tgs.name in (?) OR ?=true) AND
            (BlogsEntry.groupId = ?) AND
            (BlogsEntry.status = ?)  AND
            (BlogsEntry.companyId = ?) AND
            (? IS NULL OR BlogsEntry.displayDate > ?) AND
            (? IS NULL OR BlogsEntry.displayDate < ?)


    ]]>
    </sql>

</custom-sql>