<?xml version="1.0" encoding="UTF-8"?>
<custom-sql>
    <sql id="com.arman.csb.modules.service.MyBlogService.getGroupBlogs">
        <![CDATA[
        SELECT  distinct BlogsEntry.* , commentCNT.cnt as commentCount FROM BlogsEntry

        LEFT OUTER JOIN
        (
            SELECT AssetEntry.classPK, AssetCategory.name FROM AssetEntry

            INNER JOIN AssetEntries_AssetCategories  ON AssetEntries_AssetCategories.entryId = AssetEntry.entryId

            INNER JOIN AssetCategory ON AssetCategory.categoryId = AssetEntries_AssetCategories.categoryId
        ) AS cat ON BlogsEntry.entryId =cat.classPK

        LEFT OUTER JOIN
        (
            SELECT AssetEntry.classPK, AssetTag.name FROM AssetEntry

            INNER JOIN AssetEntries_AssetTags ON AssetEntries_AssetTags.entryId = AssetEntry.entryId

            INNER JOIN AssetTag ON AssetTag.tagId = AssetEntries_AssetTags.tagId
        ) AS tgs ON tgs.classPK = BlogsEntry.entryId

        LEFT OUTER JOIN
        (
            SELECT MBMessage.classPK , count(*) AS cnt FROM MBMessage GROUP BY classPK
        ) AS commentCNT ON commentCNT.classPK = BlogsEntry.entryId

        WHERE

            (cat.name IN (?) OR tgs.name in (?) OR ?=true) AND
            (BlogsEntry.groupId = ?) AND
            (BlogsEntry.status = ?)  AND
            (BlogsEntry.companyId = ?) AND
            (? IS NULL OR BlogsEntry.displayDate > ?) AND
            (? IS NULL OR BlogsEntry.displayDate < ?)


    ]]>
    </sql>


    <sql id="com.arman.csb.modules.service.CustomerService.search">
        <![CDATA[
            SELECT  distinct Customer.*  FROM CSBModules_Customer AS Customer

            WHERE
                (Customer.name like '##KEYWORD##') OR
                (Customer.nationalCode like '##KEYWORD##') OR
                (Customer.mobile like '##KEYWORD##') OR
                (Customer.email like '##KEYWORD##')
            ORDER BY Customer.createDate DESC

        ]]>
    </sql>


    <sql id="com.arman.csb.modules.service.ScoreService.customerScoresByDate">
        <![CDATA[
            SELECT  distinct sum(Score.value), date_trunc('day' , Score.createDate) FROM CSBModules_Customer AS Customer, CSBModules_Score AS Score
            WHERE
                Customer.id_ = Score.customerId AND Customer.id_ = ?
            GROUP BY
                date_trunc('day' , Score.createDate) , Customer.id_
            HAVING
                date_trunc('day' , Score.createDate) >= ? AND date_trunc('day' , Score.createDate) <= ?

            ORDER BY date_trunc('day' , Score.createDate) ASC

        ]]>
    </sql>

    <sql id="com.arman.csb.modules.service.ScoreService.scoresByDate">
        <![CDATA[
            SELECT  distinct sum(Score.value), date_trunc('day' , Score.createDate) FROM CSBModules_Score AS Score
            GROUP BY
                date_trunc('day' , Score.createDate)
            HAVING
                date_trunc('day' , Score.createDate) >= ? AND date_trunc('day' , Score.createDate) <= ?
            ORDER BY date_trunc('day' , Score.createDate) ASC
        ]]>
    </sql>
    <sql id="com.arman.csb.modules.service.ScoreService.scoresByMonth">
        <![CDATA[
            SELECT  distinct sum(Score.value), date_trunc('month' , Score.createDate) FROM CSBModules_Score AS Score
                WHERE Score.createDate >= ? AND Score.createDate <= ?
            GROUP BY
                date_trunc('month' , Score.createDate)
            ORDER BY date_trunc('month' , Score.createDate) ASC
        ]]>
    </sql>


    <sql id="com.arman.csb.modules.service.ScoreService.sumByCustomerAndType">
        <![CDATA[
            SELECT sum(Score.value) FROM CSBModules_Customer AS Customer, CSBModules_Score AS Score
            WHERE
                Customer.id_ = Score.customerId AND Customer.id_ = ? AND Score.type_ = ?   AND
                (? IS NULL OR Score.createDate > ?) AND
                (? IS NULL OR Score.createDate < ?)
            GROUP BY
                Customer.id_
        ]]>
    </sql>

    <sql id="com.arman.csb.modules.service.ScoreService.sumByType">
        <![CDATA[
            SELECT sum(Score.value) FROM CSBModules_Score AS Score
            WHERE
                (? = 0 OR Score.type_ = ?)   AND
                (? IS NULL OR Score.createDate > ?) AND
                (? IS NULL OR Score.createDate < ?)

        ]]>
    </sql>


</custom-sql>